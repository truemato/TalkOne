# 音声通話機能セットアップガイド

## 実装完了した機能

✅ **Agora P2P音声通話システム**
- リアルタイム音声通話
- マッチングシステム
- 3分タイマー
- 通話終了ダイアログ

## セットアップ手順

### 1. Agoraアカウント設定

1. [Agora Console](https://console.agora.io/) でアカウント作成
2. 新しいプロジェクトを作成
3. App IDをコピー

### 2. App ID設定

`lib/config/agora_config.dart` を編集：

```dart
class AgoraConfig {
  // ここにAgoraのApp IDを入力
  static const String appId = "あなたのApp IDをここに入力";
  
  // その他設定はそのまま
  // ...
}
```

### 3. 依存関係インストール

```bash
flutter pub get
```

### 4. 権限設定（既に完了）

- iOS: マイク使用許可 ✅
- Android: マニフェスト権限 ✅

## 使用方法

### 1. メイン画面
- 「通話相手を探す」ボタンをタップ

### 2. マッチング画面
- 他のユーザーを自動検索
- キャンセルボタンで中止可能

### 3. 通話画面
- 3分間のタイマー
- ミュートボタン
- 通話終了ボタン
- 音声レベル表示

## システム構成

```
┌─────────────────┐
│   メイン画面     │ → AIチャット ＋ 通話ボタン
└─────────────────┘
         ↓
┌─────────────────┐
│ マッチング画面   │ → 相手を検索・マッチング
└─────────────────┘
         ↓
┌─────────────────┐
│  音声通話画面    │ → Agora P2P通話
└─────────────────┘
         ↓
┌─────────────────┐
│  終了ダイアログ  │ → 通話時間表示・ホーム復帰
└─────────────────┘
```

## Firestoreデータ構造

### callRequests コレクション
```json
{
  "userId": "ユーザーID",
  "status": "waiting|matched|calling|finished|cancelled",
  "createdAt": "タイムスタンプ",
  "matchedWith": "相手のユーザーID",
  "channelName": "Agoraチャンネル名"
}
```

## トラブルシューティング

### よくある問題

1. **マイク権限がない**
   - 設定アプリで権限確認
   - Info.plistの設定確認

2. **Agora接続エラー**
   - App IDが正しく設定されているか確認
   - ネットワーク接続確認

3. **マッチングしない**
   - 他のユーザーが同時に通話ボタンを押している必要があります
   - Firestoreルールを確認

## テスト方法

1. **シミュレーター（音声なし）**
   - マッチング画面まで動作確認
   - 実際の音声通話は実機が必要

2. **実機2台でテスト**
   - 同じアプリを2台にインストール
   - 両方で通話ボタンを押してマッチング確認

## 次のステップ

- [ ] Agoraトークン認証（本番環境用）
- [ ] 通話品質設定
- [ ] 通話履歴保存
- [ ] 相手評価システム
- [ ] 背景ノイズ除去

## 注意事項

- 現在はテスト用設定（トークンなし）
- 本番環境では認証トークンが必要
- 3分以上の通話は自動切断
- 最大同時接続数はAgoraプランに依存