# ネットワーク接続確認機能の実装ドキュメント

## 概要
TalkOneアプリに起動時のネットワーク接続確認機能を実装しました。この機能により、ネットワーク接続がない場合でもアプリがクラッシュせず、ユーザーフレンドリーなエラー画面を表示します。

## 実装日
2025年6月15日

## 背景と問題
- **問題**: Firebase認証でネットワークエラーが発生した際、アプリが適切に処理できていなかった
- **エラー内容**: `[firebase_auth/network-request-failed] Network error`
- **影響**: ユーザーが認証失敗の理由を理解できず、アプリが使用できない状態になっていた

## 解決策

### 1. ネットワーク確認画面の作成
**ファイル**: `lib/screens/network_check_screen.dart`

#### 主な機能
- アプリ起動時に自動的にネットワーク接続を確認
- 接続失敗時にユーザーフレンドリーなエラーメッセージを表示
- リトライボタンで再接続を試行可能
- 接続成功時は自動的にホーム画面へ遷移

#### 実装詳細
```dart
class NetworkCheckScreen extends StatefulWidget {
  // ネットワーク接続とFirebase認証の両方をチェック
  Future<void> _checkConnection() async {
    // 1. connectivity_plusでネットワーク状態を確認
    // 2. Firebase匿名認証を試行
    // 3. 成功時はHomeScreenへ遷移
    // 4. 失敗時はエラーメッセージとリトライボタンを表示
  }
}
```

### 2. 依存関係の追加
**ファイル**: `pubspec.yaml`
```yaml
dependencies:
  connectivity_plus: ^6.0.2  # ネットワーク接続確認用
```

### 3. アプリのエントリーポイント変更
**ファイル**: `lib/main.dart`
```dart
// 変更前
home: const AuthWrapper(),

// 変更後
home: const NetworkCheckScreen(),
```

## UI/UXデザイン

### 接続確認中
- 円形のプログレスインジケーター
- 「接続を確認しています...」メッセージ
- アプリロゴの表示

### 接続失敗時
- Wi-Fiオフアイコン（赤色）
- エラーメッセージ（例：「インターネットに接続されていません」）
- 補足説明（「インターネット接続を確認してください」）
- リトライボタン（アイコン付き）

### デザイン仕様
- **カラー**: エラー時は赤色（Colors.red[400]、Colors.red[700]）
- **アイコンサイズ**: 64px（エラーアイコン）、60px（アプリロゴ）
- **ボタンスタイル**: 角丸（30px）、パディング（水平32px、垂直16px）

## 技術的な実装詳細

### ネットワーク確認フロー
1. **Connectivityチェック**
   ```dart
   final connectivityResult = await Connectivity().checkConnectivity();
   if (connectivityResult == ConnectivityResult.none) {
     // ネットワーク接続なし
   }
   ```

2. **Firebase認証チェック**
   ```dart
   await FirebaseAuth.instance.signInAnonymously();
   ```

3. **エラーハンドリング**
   - ネットワーク未接続: 「インターネットに接続されていません」
   - Firebase接続失敗: 「サーバーに接続できません」
   - その他のエラー: 「接続エラーが発生しました」

### 状態管理
- `_isChecking`: 接続確認中の状態を管理
- `_errorMessage`: エラーメッセージの表示制御

## 利点
1. **ユーザー体験の向上**: 明確なエラーメッセージとアクション
2. **エラー耐性**: ネットワーク障害時でもアプリがクラッシュしない
3. **再試行可能**: ユーザーが簡単に再接続を試みることができる
4. **視覚的フィードバック**: 現在の状態が一目で分かる

## 今後の改善案
1. **オフラインモード**: 一部機能をオフラインで利用可能にする
2. **自動リトライ**: 一定間隔で自動的に再接続を試みる
3. **詳細なエラー情報**: デバッグモードでより詳細なエラー情報を表示
4. **接続タイムアウト設定**: カスタマイズ可能なタイムアウト時間

## 関連ファイル
- `/lib/screens/network_check_screen.dart` - ネットワーク確認画面
- `/lib/main.dart` - アプリエントリーポイント
- `/pubspec.yaml` - 依存関係定義

## テスト方法
1. デバイスの機内モードをONにしてアプリを起動
2. エラー画面が表示されることを確認
3. 機内モードをOFFにしてリトライボタンをタップ
4. 正常にホーム画面に遷移することを確認